"use strict"
function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i]
n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),spinner=null,environment="debug",Bootstrapper=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"Run",value:function(){function e(){var e=$(this),t=e.find(".modal-dialog")
e.css("display","block"),t.css("margin-top",Math.max(0,($(window).height()-t.height())/2))}var t=$.Deferred(),i=null
spinner=new LoadingSpinner,$(".navbar-collapse ul li a").click(function(){$(".navbar-toggle:visible").click()}),$("body").scrollspy({target:".navbar-fixed-top"}),$(".modal").on("show.bs.modal",e),$(window).on("resize",function(){$(".modal:visible").each(e)}),navigator.userAgent.match(/iPhone|iPad|iPod/i)&&$(".modal").on("show.bs.modal",function(){$(this).css({position:"absolute",marginTop:$(window).scrollTop()+"px",bottom:"auto"}),setTimeout(function(){$(".modal-backdrop").css({position:"absolute",top:0,left:0,width:"100%",height:Math.max(document.body.scrollHeight,document.documentElement.scrollHeight,document.body.offsetHeight,document.documentElement.offsetHeight,document.body.clientHeight,document.documentElement.clientHeight)+"px"})},0)})
var n="Application failed to initialize."
return async.series([function(e){$("#order-form-tmpl").load("./templates/order-form-tmpl.html",function(t,i,r){"error"===i?e(n):e()})},function(e){$("#vehicle-tmpl").load("./templates/vehicle-tmpl.html",function(t,i,r){"error"===i?e(n):e()})},function(e){$("#location-tmpl").load("./templates/location-tmpl.html",function(t,i,r){"error"===i?e(n):e()})},function(e){i=new WebService,i.GetEnvironment().then(function(t){environment=t,e()}).fail(function(t){return e(t)})},function(e){var t=new LocalStorageHelper(sessionStorage),n=new OrderFormViewModel(t,i),r=new LogInViewModel(t,i),o=new MainViewModel(t,r,n)
ko.applyBindings(o),i.GetFutureAppointments().then(function(i){var n=_.groupBy(i,function(e){return moment(e.date).format("MM/DD/YYYY")})
t.AppointmentsByDate=n,e()}).fail(function(t){e(t)})}],function(e){e?t.reject(e):t.resolve()}),t.promise()}}]),e}(),cbpAnimatedHeader=function(){function e(){window.addEventListener("scroll",function(e){o||(o=!0,setTimeout(t,250))},!1)}function t(){var e=i()
e>=a?classie.add(r,"navbar-shrink"):classie.remove(r,"navbar-shrink"),o=!1}function i(){return window.pageYOffset||n.scrollTop}var n=document.documentElement,r=document.querySelector(".navbar-default"),o=!1,a=300
e()}()
!function(e){function t(e){return new RegExp("(^|\\s+)"+e+"(\\s+|$)")}function i(e,t){var i=n(e,t)?o:r
i(e,t)}var n,r,o
"classList"in document.documentElement?(n=function(e,t){return e.classList.contains(t)},r=function(e,t){e.classList.add(t)},o=function(e,t){e.classList.remove(t)}):(n=function(e,i){return t(i).test(e.className)},r=function(e,t){n(e,t)||(e.className=e.className+" "+t)},o=function(e,i){e.className=e.className.replace(t(i)," ")})
var a={hasClass:n,addClass:r,removeClass:o,toggleClass:i,has:n,add:r,remove:o,toggle:i}
"function"==typeof define&&define.amd?define(a):e.classie=a}(window)
var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i]
n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),ORDER_SUCCESS_MSG="Thank you! Your order has been placed. Please check your email for confirmation.",ORDER_FAILURE_MSG="We're really sorry about this... Looks like there was a problem submitting your order. Please contact us for support.",BAD_ZIP_MSG=s.sprintf("Sorry about this but we don't service your area yet! We're still young and growing so check back soon. Feel free to <a href=%s>contact us</a> to expedite the process. <BR><BR> Sincerely, <BR> - The WMC Team","javascript:$('.modal').modal('hide');$('#contact-nav').click();"),ASYNC_INTERUPTION_MARKER="ASYNC_INTERUPTION_MARKER",DEFAULT_JOB_TIME_MINS=120,MAX_JOB_TIME_PER_DAY_MINS=720,MAX_JOB_TIME_PER_INTERVAL=180,WASH_DETAILS={title:"Hand wash",time:30,price:22},TIRE_SHINE_DETAILS={title:"Tire shine",time:30,price:20},INTERIOR_DETAILS={title:"Interior cleaning",time:50,price:60},WAX_DETAILS={title:"Hand wax & buff",time:50,price:50},MORNING_TIME_RANGE={range:"9:00 - 12:00 PM",key:1,disabled:ko.observable(!1)},AFTERNOON_TIME_RANGE={range:"12:00 - 3:00 PM",key:2,disabled:ko.observable(!1)},EVENING_TIME_RANGE={range:"3:00 - 6:00 PM",key:3,disabled:ko.observable(!1)},NIGHT_TIME_RANGE={range:"6:00 - 9:00 PM",key:4,disabled:ko.observable(!1)},CAR_SIZES=[{size:"Compact (2-4 door)",multiplier:1},{size:"SUV (5-door)",multiplier:1.2},{size:"XXL",multiplier:1.4}],ZIP_WHITE_LIST=["22314","22301","22305","22302","22304","22202","22206","22311","22312","22204","22041","22211","22201","22203","22209","22044","22151","22150","22152","22153","22015","22205","22042","22046","22003","22207","22213","22031","22043","22027","22101","22182","22030","22032","22039","20124"],Constants=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"TIRE_SHINE_DETAILS",get:function(){return TIRE_SHINE_DETAILS}},{key:"INTERIOR_DETAILS",get:function(){return INTERIOR_DETAILS}},{key:"WAX_DETAILS",get:function(){return WAX_DETAILS}},{key:"WASH_DETAILS",get:function(){return WASH_DETAILS}},{key:"ZIP_WHITE_LIST",get:function(){return ZIP_WHITE_LIST}},{key:"MORNING_TIME_RANGE",get:function(){return MORNING_TIME_RANGE}},{key:"AFTERNOON_TIME_RANGE",get:function(){return AFTERNOON_TIME_RANGE}},{key:"EVENING_TIME_RANGE",get:function(){return EVENING_TIME_RANGE}},{key:"NIGHT_TIME_RANGE",get:function(){return NIGHT_TIME_RANGE}},{key:"CAR_SIZES",get:function(){return CAR_SIZES}},{key:"ORDER_SUCCESS_MSG",get:function(){return ORDER_SUCCESS_MSG}},{key:"ORDER_FAILURE_MSG",get:function(){return ORDER_FAILURE_MSG}},{key:"BAD_ZIP_MSG",get:function(){return BAD_ZIP_MSG}},{key:"ASYNC_INTERUPTION_MARKER",get:function(){return ASYNC_INTERUPTION_MARKER}},{key:"MAX_JOB_TIME_PER_INTERVAL",get:function(){return MAX_JOB_TIME_PER_INTERVAL}}]),e}()
window.jQuery(document).ready(function(e){function t(){var e="This is embarrassing... something went wrong and our app will not work correctly.		Please make sure you have a good internet connection and refresh the page."
bootbox?bootbox.alert(e):alert(e)}try{Bootstrapper.Run().then(function(){var t=setTimeout(function(){e("#splash").fadeOut(1e3),clearTimeout(t)},2e3)}).fail(function(e){console.error(e),t()})}catch(i){t()}})
var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i]
n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),LocalStorageHelper=function(){function e(t){_classCallCheck(this,e),"undefined"==typeof Storage?console.info("No local storage available."):this.storageType=t}return _createClass(e,[{key:"ZipCode",get:function(){return this.storageType&&this.storageType.zip?this.storageType.zip:""},set:function(e){this.storageType&&(this.storageType.zip=e)}},{key:"AppointmentsByDate",get:function(){return this.storageType&&this.storageType.appointments?JSON.parse(this.storageType.appointments):[]},set:function(e){this.storageType&&(this.storageType.appointments=JSON.stringify(e))}},{key:"LoggedInUser",get:function(){return this.storageType&&this.storageType.loggedInUser?JSON.parse(this.storageType.loggedInUser):null},set:function(e){this.storageType&&(this.storageType.loggedInUser=JSON.stringify(e))}}]),e}(),_createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i]
n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),LoadingSpinner=function(){function e(){_classCallCheck(this,e)
var t=12,i=12,n=30,r=t+i+n
this.spinner=null,this.options={lines:13,length:i,width:t,radius:n,scale:1,corners:1,color:"#0076A3",opacity:.35,rotate:0,direction:1,speed:.8,trail:45,fps:20,zIndex:2e9,className:"spinner",top:"-"+r.toString(),left:"-"+r.toString(),shadow:!0,hwaccel:!0,position:"relative"},this.spinnerOverlay=$("#page-load-spinner"),this.spinnerContainer=document.getElementById("spinner-container")}return _createClass(e,[{key:"Show",value:function(){$(this.spinnerOverlay).is(":visible")||(this.spinnerOverlay.show(),this.spinner?this.spinner.spin(this.spinnerContainer):this.spinner=new Spinner(this.options).spin(this.spinnerContainer))}},{key:"Hide",value:function(){this.spinnerOverlay.hide(),this.spinner&&this.spinner.stop()}}]),e}(),_createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i]
n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),Utils=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"GetListOfDisabledDates",value:function(e){if(!e)return[]
var t=[]
for(var i in e)if(e.hasOwnProperty(i)){var n=0,r=e[i]
_.each(r,function(e){n+=e.timeEstimate?e.timeEstimate:Contsants.DEFAULT_JOB_TIME_MINS}),n>Constants.MAX_JOB_TIME_PER_DAY_MINS&&t.push(_.first(r).date)}return t}},{key:"VerifyZip",value:function(e){return _.contains(Constants.ZIP_WHITE_LIST,e.trim())}},{key:"IsStrEqual",value:function(e,t){var i=e.trim().toUpperCase(),n=t.trim().toUpperCase()
return i===n}},{key:"GenerateUUID",value:function(){var e=(new Date).getTime(),t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var i=(e+16*Math.random())%16|0
return e=Math.floor(e/16),("x"==t?i:3&i|8).toString(16)})
return t}}]),e}(),_createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i]
n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),LogInViewModel=function(){function e(t,i){_classCallCheck(this,e),this.storageHelper=t,this.webSvc=i,this.$loginModal=$("#login-modal"),this.$orderFormModal=$("#order-form-modal"),this.$loginForm=$("#login-form"),this.$createAcctForm=$("#create-acct-form"),this.$forgotPwdForm=$("#forgot-pwd-form"),this.ShowLogin=ko.observable(!0),this.ShowCreateAcct=ko.observable(!1),this.ShowForgotPwd=ko.observable(!1),this.email=ko.observable(),this.pwd=ko.observable(),this.firstName=ko.observable(""),this.lastName=ko.observable(""),this.phone=ko.observable(""),this.verifyPwd=ko.observable(""),this.verifyEmail=ko.observableArray(""),this._initValidation()}return _createClass(e,[{key:"OnContinueAsGuest",value:function(){this._resetForms(),this._toggleModals()}},{key:"OnShowCreateAcct",value:function(){this._resetForms(),this.ShowForgotPwd(!1),this.ShowLogin(!1),this.ShowCreateAcct(!0)}},{key:"OnCancelCreateAcct",value:function(){this._resetForms(),this.ShowForgotPwd(!1),this.ShowCreateAcct(!1),this.ShowLogin(!0)}},{key:"OnCreateAcct",value:function(){var e=this
this.$createAcctForm.valid()&&(spinner.Show(),async.series([this._checkIfEmailExists.bind(this),this._createNewUser.bind(this)],function(t){spinner.Hide(),t===Constants.ASYNC_INTERUPTION_MARKER?bootbox.alert("That email is already in use! Did you forget your password?"):t?bootbox.alert("There was a problem creating your account."):e._toggleModals()}))}},{key:"OnLogIn",value:function(){var e=this
this.$loginForm.valid()&&(spinner.Show(),this.webSvc.GetUserByEmailAndPwd(this.email(),this.pwd()).then(function(t){t?(e.storageHelper.LoggedInUser=t,e._resetForms(),e._toggleModals()):(bootbox.alert("Hmmm, we didn't find an account matching those credentials. 							Please verify your info and try again or click the 'Forgot Password' link."),e._resetForms(),e.$loginForm.valid())}).fail(function(t){e._resetForms(),bootbox.alert("Uh oh... something went wrong!")}).always(function(){return spinner.Hide()}))}},{key:"OnShowForgotPwd",value:function(){this._resetForms(),this.ShowLogin(!1),this.ShowCreateAcct(!1),this.ShowForgotPwd(!0)}},{key:"OnCancelForgotPwd",value:function(){this._resetForms(),this.ShowCreateAcct(!1),this.ShowForgotPwd(!1),this.ShowLogin(!0)}},{key:"OnSubmitForgotPwd",value:function(){if(this.$forgotPwdForm.valid()){var e=this
spinner.Show(),this.webSvc.ForgotPassword(this.email()).then(function(){bootbox.alert("Nice! Check your email ;)"),e._resetForms(),e.OnCancelForgotPwd()}).fail(function(t){bootbox.alert("Uh oh, there was a problem..."),console.log(t),e._resetForms()}).always(function(){return spinner.Hide()})}}},{key:"_checkIfEmailExists",value:function(e){this.webSvc.GetUserByEmail(this.email()).then(function(t){t?e(Constants.ASYNC_INTERUPTION_MARKER):e()}).fail(function(t){e(t)})}},{key:"_createNewUser",value:function(e){var t=this,i={email:this.email(),pwd:this.pwd()}
this.webSvc.CreateUser(i).then(function(i){t.storageHelper.LoggedInUser=i,e()}).fail(function(t){e(t)})}},{key:"_resetForms",value:function(){this.$loginForm.find("input").val(""),this.$loginForm.validate().resetForm(),this.$createAcctForm.find("input").val(""),this.$createAcctForm.validate().resetForm(),this.$forgotPwdForm.find("input").val(""),this.$forgotPwdForm.validate().resetForm()}},{key:"_toggleModals",value:function(){this.$loginModal.removeClass("fade"),this.$loginModal.modal("hide"),this.$loginModal.addClass("fade"),this.$orderFormModal.modal("show")}},{key:"_initValidation",value:function(){var e=this
$.validator.addMethod("pwdLength",function(e){return e&&e.length>=8}),$.validator.addMethod("pwdEqual",function(){return e.pwd()===e.verifyPwd()},"Passwords do not match!"),$.validator.addMethod("emailEqual",function(){return Utils.IsStrEqual(e.email(),e.verifyEmail())},"Emails do not match!"),this.$createAcctForm.validate({rules:{email:{required:!0,email:!0},verifyEmail:{required:!0,emailEqual:!0},pwd:{required:!0,pwdLength:!0},verifyPwd:{required:!0,pwdEqual:!0}},messages:{email:"Please enter a valid email address.",pwd:"Password must be at least 8 characters."}}),this.$loginForm.validate({rules:{email:{required:!0,email:!0},pwd:"required"},messages:{email:"Please enter a valid email address.",pwd:"Password required."}}),this.$forgotPwdForm.validate({rules:{email:{required:!0,email:!0},verifyEmail:{required:!0,emailEqual:!0}},messages:{email:"Please enter a valid email address."}})}}]),e}(),_createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i]
n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),MainViewModel=function(){function e(t,i,n){_classCallCheck(this,e),this.WASH_COST=Constants.WASH_DETAILS.price,this.TireShinePriceHtml="<sup>$</sup>"+Constants.TIRE_SHINE_DETAILS.price,this.InteriorPriceHtml="<sup>$</sup>"+Constants.INTERIOR_DETAILS.price,this.WaxPriceHtml="<sup>$</sup>"+Constants.WAX_DETAILS.price,this.LogInViewModel=i,this.OrderFormViewModel=n,this.storageHelper=t,this.zip=ko.observable(""),this.storageHelper.ZipCode?this.zipVerified=ko.observable(!0):this.zipVerified=ko.observable(!1)}return _createClass(e,[{key:"OnPageScroll",value:function(e,t){var i=$(t.currentTarget)
$("html, body").stop().animate({scrollTop:$(i.attr("href")).offset().top},1500,"easeInOutExpo"),t.preventDefault()}},{key:"OnVerifyZip",value:function(){Utils.VerifyZip(this.zip())?(this.zipVerified(!0),this.storageHelper.ZipCode=this.zip()):bootbox.alert(Constants.BAD_ZIP_MSG)}}]),e}(),_createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i]
n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),OrderFormViewModel=function(){function e(t,i){_classCallCheck(this,e)
var n=this
this.stripeHandler=StripeCheckout.configure({key:"production"==environment?"pk_live_aULtlGy6YPvc94K5Hjvqwokg":"pk_test_luqEThs0vblV173fgAHgPZBG",image:"/img/square_logo.png",locale:"auto",token:this._completeOrder.bind(this)}),$(window).on("popstate",function(){n.stripeHandler.close()}),this.webSvc=i,this.$orderFormModal=$("#order-form-modal"),this.$orderFormModal.on("show.bs.modal",function(){n._prePopulateUserData()}),this.storageHelper=t
t.LoggedInUser
this.TIRE_SHINE_COST=Constants.TIRE_SHINE_DETAILS.price,this.INTERIOR_COST=Constants.INTERIOR_DETAILS.price,this.WAX_COST=Constants.WAX_DETAILS.price,this.WASH_COST=Constants.WASH_DETAILS.price,this.disableEmailInput=ko.observable(!1),this.addShine=ko.observable(!1),this.addWax=ko.observable(!1),this.addInterior=ko.observable(!1),this.showBillingAddress=ko.observable(!1),this.description=ko.observable(""),this.timeRangeOptions=[Constants.MORNING_TIME_RANGE,Constants.AFTERNOON_TIME_RANGE,Constants.EVENING_TIME_RANGE,Constants.NIGHT_TIME_RANGE],this.selectedTimeRange=ko.observable(this.timeRangeOptions[0]),this.date=ko.observable(moment().format("MM/DD/YY")),this.showAddVehicleForm=ko.observable(!1),this.cars=ko.observableArray([]),this.make=ko.observable(""),this.model=ko.observable(""),this.color=ko.observable(""),this.tag=ko.observable(""),this.carSizes=Constants.CAR_SIZES,this.selectedCarSize=ko.observable(this.carSizes[0]),this.carYears=[]
for(var r=(new Date).getFullYear()+1,o=0;25>o;o++)this.carYears.push((r-o).toString())
this.carYear=ko.observable(this.carYears[1]),this.first=ko.observable(""),this.last=ko.observable(""),this.email=ko.observable(""),this.phone=ko.observable(""),this.showAddLocationForm=ko.observable(!1),this.locations=ko.observableArray([]),this.locationTitleOptions=["Home","Work","Other"],this.title=ko.observable(this.locationTitleOptions[0]),this.street=ko.observable(""),this.city=ko.observable(""),this.state=ko.observable(""),this.zip=ko.observable(this.storageHelper.ZipCode),this.orderTotal=ko.computed(function(){var e=0,t=parseFloat(n.WASH_COST+(n.addShine()?n.TIRE_SHINE_COST:0)+(n.addWax()?n.WAX_COST:0)+(n.addInterior()?n.INTERIOR_COST:0))
return n.cars().forEach(function(i){if(i.selected()){var n=_.find(Constants.CAR_SIZES,function(e){return e.size==i.size||e.multiplier==i.multiplier})
n&&(e+=t*n.multiplier)}}),10>e?e.toPrecision(3):e>=100?e.toPrecision(5):e.toPrecision(4)}),this.orderSummary=ko.computed(function(){var e=""
return n.cars().forEach(function(t){if(t.selected()){var i=_.find(Constants.CAR_SIZES,function(e){return e.size==t.size||e.multiplier==t.multiplier})
e+=$.validator.format("<strong>{5} {6}</strong><br>Exterior Hand Wash<br>{0}{1}{2}{3} = {4}x cost multiplier.<br>",n.addShine()?"Deep Tire Clean & Shine<br>":"",n.addWax()?"Hand Wax & Buff<br>":"",n.addInterior()?"Full Interior Cleaning<br>":"",i.size,i.multiplier.toString(),t.make,t.model)}}),e})}return _createClass(e,[{key:"OnAfterRender",value:function(e,t){t.$addVehicleForm=$("#add-vehicle-form"),t.$addLocationForm=$("#add-location-form"),t.$orderDetailsForm=$("#order-details-form"),$("#phone").mask("(999) 999-9999? ext:99999",{placeholder:" "}),$("#datetimepicker").datetimepicker({minDate:new Date,format:"MM/DD/YY",ignoreReadonly:!0}).on("dp.change",t._onDatepickerChange.bind(t)),t._initValidation()}},{key:"OnAddNewLocation",value:function(){this.showAddLocationForm(!0)}},{key:"OnCancelNewLocation",value:function(){this.$addVehicleForm.find("input").val(""),this.$addLocationForm.validate().resetForm(),this.showAddLocationForm(!1)}},{key:"OnSaveNewLocation",value:function(){if(this.$addLocationForm.valid()){var e=this._makeLocationSchema()
_.each(this.locations(),function(e){return e.selected(!1)}),e.selected(!0),this.locations.push(e),this.$addLocationForm.find("input").val(""),this.showAddLocationForm(!1)}}},{key:"OnAddNewVehicle",value:function(){this.showAddVehicleForm(!0)}},{key:"OnCancelNewVehicle",value:function(){this.$addVehicleForm.find("input").val(""),this.$addVehicleForm.validate().resetForm(),this.showAddVehicleForm(!1)}},{key:"OnSaveNewVehicle",value:function(){if(this.$addVehicleForm.valid()){var e=this._makeCarSchema()
e.selected(!0),this.cars.push(e),this.$addVehicleForm.find("input").val(""),this.showAddVehicleForm(!1)}}},{key:"OnClickVehiclePanel",value:function(e,t){t.selected(!t.selected())}},{key:"OnDeleteVehiclePanel",value:function(e,t){e.cars(_.reject(e.cars(),function(e){return _.isEqual(e,t)}))}},{key:"OnClickLocationPanel",value:function(e,t){_.each(e.locations(),function(e){e.selected(!1)}),t.selected(!0)}},{key:"OnDeleteLocationPanel",value:function(e,t){e.locations(_.reject(e.locations(),function(e){return _.isEqual(e,t)}))}},{key:"OnSubmit",value:function(){var e=_.filter(this.cars(),function(e){return e.selected()})
if(0===e.length)return void bootbox.alert("Please add and select at least one vehicle.")
var t=_.find(this.locations(),function(e){return e.selected()})
return t?Utils.VerifyZip(t.zip)?void(this.$orderDetailsForm.valid()&&this._openCheckout()):void bootbox.alert(Constants.BAD_ZIP_MSG):void bootbox.alert("Please add and select a location.")}},{key:"OnFormCancel",value:function(){try{this.$orderFormModal.modal("hide"),window.location="#page-top",this.addShine(!1),this.addWax(!1),this.addInterior(!1),this.showBillingAddress(!1),this.description(""),this.showAddVehicleForm(!1),this.showAddLocationForm(!1),$("#datetimepicker").data("DateTimePicker").date(new Date),this.selectedCarSize(this.carSizes[0]),this.selectedTimeRange(this.timeRangeOptions[0]),this.carYear(this.carYears[1]),this.$orderDetailsForm.validate().resetForm()}catch(e){console.log("Failed to reset fields OnFormCancel()"),console.log(e)}}},{key:"_openCheckout",value:function(){this.stripeHandler.open({key:"pk_test_luqEThs0vblV173fgAHgPZBG",name:"WMC",description:"2 widgets",amount:100*this.orderTotal(),zipCode:!0,email:this.email()})}},{key:"_completeOrder",value:function(e){try{var t=this
spinner.Show(),async.series([this._executeCharge.bind(this,e),this._verifyUser.bind(this),this._updateUserData.bind(this),this._sendEmailConfirmation.bind(this)],function(e){e?t._onOrderFailure(e):t._onOrderSuccess()})}catch(i){this._onOrderFailure(i)}}},{key:"_onOrderFailure",value:function(e){spinner.Hide(),bootbox.alert(Constants.ORDER_FAILURE_MSG),console.log(e)}},{key:"_onOrderSuccess",value:function(){spinner.Hide(),bootbox.alert(Constants.ORDER_SUCCESS_MSG),this.OnFormCancel()}},{key:"_sendEmailConfirmation",value:function(e){this.webSvc.SendConfirmationEmail(this.storageHelper.LoggedInUser.email,this.storageHelper.LoggedInUser.appointments).then(function(){return e()}).fail(function(t){return e(t)})}},{key:"_verifyUser",value:function(e){var t=this
this.storageHelper.LoggedInUser?e():this.webSvc.GetUserByEmail(this.email()).then(function(i){if(i)t.storageHelper.LoggedInUser=i,e()
else{var n=t._makeGuestUserSchema()
t.storageHelper.LoggedInUser=n,t.webSvc.CreateUser(n).then(function(){return e()}).fail(function(t){return e(t)})}}).fail(function(t){return e(t)})}},{key:"_executeCharge",value:function(e,t){this.webSvc.ExecuteCharge(e,100*this.orderTotal(),this.last()).then(function(){return t()}).fail(function(e){return t(e)})}},{key:"_updateUserData",value:function(e){var t=this.storageHelper.LoggedInUser,i=this._makeAppointmentSchema()
null!=t.appointments?t.appointments.push(i):t.appointments=[i],t.cars=this.cars(),t.phone=this.phone(),t.locations=this.locations(),t.firstName=this.first(),t.lastName=this.last(),this.storageHelper.LoggedInUser=t,this.webSvc.UpdateUser(t).then(function(){return e()}).fail(function(t){return e(t)})}},{key:"_prePopulateUserData",value:function(){var e=this.storageHelper.LoggedInUser
if(e){var t=e.locations||[],i=e.cars||[]
_.each(t,function(e){return e.selected=ko.observable(!1)}),_.each(i,function(e){return e.selected=ko.observable(!1)}),this.locations(t),this.cars(i),this.email(e.email||""),this.phone(e.phone||""),this.first(e.firstName||""),this.last(e.lastName||""),e.email&&this.disableEmailInput(!0),$("#phone").trigger("input")}}},{key:"_onDatepickerChange",value:function(e){var t=moment(e.date).format("MM/DD/YYYY")
this.date(t)
var i=this.storageHelper.AppointmentsByDate[t]
if(i){var n=Constants.MAX_JOB_TIME_PER_INTERVAL,r=_.filter(i,function(e){return e.timeRangeKey===Constants.MORNING_TIME_RANGE.key}),o=_.filter(i,function(e){return e.timeRangeKey===Constants.AFTERNOON_TIME_RANGE.key}),a=_.filter(i,function(e){return e.timeRangeKey===Constants.EVENING_TIME_RANGE.key}),s=_.filter(i,function(e){return e.timeRangeKey===Constants.NIGHT_TIME_RANGE.key})
Constants.MORNING_TIME_RANGE.disabled(_.reduce(r,function(e,t){return e+t.timeEstimate},0)>n),Constants.AFTERNOON_TIME_RANGE.disabled(_.reduce(o,function(e,t){return e+t.timeEstimate},0)>n),Constants.EVENING_TIME_RANGE.disabled(_.reduce(a,function(e,t){return e+t.timeEstimate},0)>n),Constants.NIGHT_TIME_RANGE.disabled(_.reduce(s,function(e,t){return e+t.timeEstimate},0)>n)}}},{key:"_initValidation",value:function(){this.$orderDetailsForm.validate({rules:{first:"required",last:"required",email:{required:!0,email:!0},phone:"required"},messages:{email:"Please enter a valid email address."}}),this.$addVehicleForm.validate({rules:{make:"required",model:"required",color:"required"}}),this.$addLocationForm.validate({rules:{street:"required",city:"required",state:"required",zip:"required"}})}},{key:"_makeGuestUserSchema",value:function(){return{email:this.email(),pwd:Utils.GenerateUUID()}}},{key:"_makeCarSchema",value:function(){return{color:this.color(),make:this.make(),model:this.model(),size:this.selectedCarSize().size,tag:this.tag(),year:parseInt(this.carYear()),selected:ko.observable(!1)}}},{key:"_makeAppointmentSchema",value:function(){return{cars:[this._makeCarSchema()],date:new Date(this.date()),location:this._makeLocationSchema(),price:this.orderTotal(),services:this._buildServicesArray(),timeEstimate:this._getTimeEstimate(),timeRange:this.selectedTimeRange().range,timeRangeEnum:this.selectedTimeRange().key,description:this.description()}}},{key:"_makeLocationSchema",value:function(){return{city:this.city(),state:this.state(),street:this.street(),title:this.title(),zip:this.zip(),selected:ko.observable(!1)}}},{key:"_getTimeEstimate",value:function(){var e=Constants.WASH_DETAILS.time
return this.addShine()&&(e+=Constants.TIRE_SHINE_DETAILS.time),this.addWax()&&(e+=Constants.WAX_DETAILS.time),this.addInterior()&&(e+=Constants.INTERIOR_DETAILS.time),e}},{key:"_buildServicesArray",value:function(){var e=[Constants.WASH_DETAILS.title]
return this.addShine()&&e.push(Constants.TIRE_SHINE_DETAILS.title),this.addWax()&&e.push(Constants.WAX_DETAILS.title),this.addInterior()&&e.push(Constants.INTERIOR_DETAILS.title),e}}]),e}(),_createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i]
n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),WebService=function(){function e(){_classCallCheck(this,e),this.baseUrl=document.location.origin,this.deferred=null}return _createClass(e,[{key:"GetFutureAppointments",value:function(){return this._executeAjaxCall("GET","/api/getFutureApptDatesAndTimes")}},{key:"CreateUser",value:function(e){return this._executeAjaxCall("POST","/api/createNewUser",e)}},{key:"GetUserByEmail",value:function(e){return this._executeAjaxCall("POST","/api/getUserByEmail",{email:e})}},{key:"GetUserByEmailAndPwd",value:function(e,t){return this._executeAjaxCall("POST","/api/getUserByEmailAndPwd",{email:e,pwd:t})}},{key:"SendConfirmationEmail",value:function(e,t){return this._executeAjaxCall("POST","/api/sendConfirmationEmail",{email:e,appointments:t})}},{key:"UpdateUser",value:function(e){return this._executeAjaxCall("PUT","/api/updateUser",e)}},{key:"ForgotPassword",value:function(e){return this._executeAjaxCall("POST","/api/forgotPassword",{email:e})}},{key:"GetEnvironment",value:function(){return this._executeAjaxCall("GET","/api/getEnvironment")}},{key:"ExecuteCharge",value:function(e,t,i){return this._executeAjaxCall("POST","/api/executeCharge",{stripeToken:e.id,price:t,lastName:i,email:e.email})}},{key:"_executeAjaxCall",value:function(e,t,i){return this.deferred=$.Deferred(),$.ajax({url:this.baseUrl+t,type:e,contentType:"application/json; charset=UTF-8",dataType:"json",error:this._onError.bind(this),success:this._onSuccess.bind(this),timeout:1e4,data:JSON.stringify(i)}),this.deferred.promise()}},{key:"_onSuccess",value:function(e,t,i){if(console.info(e,t,i),this.deferred){var n=e?e.data:null
this.deferred.resolve(n)}}},{key:"_onError",value:function(e,t,i){console.error(e,t,i),this.deferred&&this.deferred.reject(i)}}]),e}()
